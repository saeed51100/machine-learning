I am developing a time-series classification pipeline in Python (Jupyter Notebook) to identify Forex price trend regimes based on historical price data.
The dataset consists of approximately 170,000 rows of Forex OHLCV data on the H1 (hourly) timeframe, with the following characteristics:
* Dataset Description
     The dataset contains a 'CLOSE' price column and a corresponding 'Label' column that indicates price trend events with three classes:
        0 → No meaningful trend (sideways / flat movement)
        1 → Bullish trend
        2 → Bearish trend


* Request
I have implemented a labeling algorithm that assigns these labels based on price movements.
Please carefully review the code below and propose one critical improvement that addresses the most important weakness in the current implementation.
Your goal is to make the labeling logic more robust, scalable, and suitable for large time-series datasets.
Focus only on this single improvement, explain why it is necessary, and provide the complete corrected version of the code incorporating that improvement.
// My code:
