Please think long and hard.
I am developing a time-series classification pipeline in Python (Jupyter Notebook) to identify Forex price trend regimes based on historical price data.

The dataset consists of approximately 170,000 rows of Forex OHLCV data on the H1 (hourly) timeframe, with the following characteristics:
* Dataset Description
    1- The main DataFrame df contains 140,000 rows and 10 columns:
        DATETIME, DATE, TIME, OPEN, HIGH, LOW, CLOSE, TICKVOL, VOL, SPREAD.
    2- Each row represents one hour of Forex price data.
    3- The dataset is fully continuous; all weekend and holiday gaps have already been forward-filled.
    4- The DATETIME column is strictly chronological and represents the true time index.

* Objective
    I want to create a new DataFrame named df_model as a copy of df and add a new column called Label, subject to the following rules:

* Label Definition
    The Label column should represent the dominant price trend as follows:
        0 → No meaningful trend (sideways / flat movement)
        1 → Bullish trend
        2 → Bearish trend

* Labeling Rules
    1- Labels must be computed exclusively from the CLOSE price.
    2- A bullish trend (Label = 1) is defined as the CLOSE price increasing over several consecutive periods.
    3- A bearish trend (Label = 2) is defined as the CLOSE price decreasing over several consecutive periods.
    4- If the price movement is approximately flat, the label should be 0.
    5- Minor price fluctuations and market noise must be ignored; small price changes within a predefined threshold should not be considered a trend.

* Task
     Please write Python code that:

        - Creates a copy of df named df_model and adds a new Label column
        - Computes labels using only past and current CLOSE values, ensuring strict causality and no future data leakage
        - Determines trend direction using a configurable rolling lookback window and an aggregated price-change metric (e.g., cumulative return or slope)
        - Applies noise filtering via configurable absolute and/or percentage thresholds to ignore insignificant price movements
        - Enforces a minimum trend persistence requirement (e.g., consecutive confirmations) to reduce whipsaws
        - Explicitly handles boundary conditions (warm-up period, initial NaNs)
        - Keeps the entire labeling logic fully parameterized, reproducible, and reusable
        - Is robust and suitable for integration into a time-series machine learning pipeline (e.g., feature engineering before model training)